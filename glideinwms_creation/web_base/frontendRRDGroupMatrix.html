<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<!--
Project:
  glideinWMS

File Version: 
  $Id: frontendRRDGroupMatrix.html,v 1.1.8.3 2011/03/22 19:22:18 dweitzel Exp $

Description:
  Browse the glideinWMS RRDs over the groups

  Based on
  javascriptrrd/src/lib/rrdJFlot.html 
   Original repository: http://javascriptrrd.sourceforge.net/
-->

<html>
  
    <script type="text/javascript" src="jslibs/binaryXHR.js"></script>
    <script type="text/javascript" src="jslibs/rrdFile.js"></script>

    <!-- rrdFlot class needs the following four include files !-->
    <script type="text/javascript" src="jslibs/rrdFlotSupport.js"></script>
    <script type="text/javascript" src="jslibs/rrdFlotMatrix.js"></script>
    <script type="text/javascript" src="jslibs/jquery.js"></script>
    <script type="text/javascript" src="jslibs/jquery.flot.js"></script>
    <script type="text/javascript" src="jslibs/jquery.flot.selection.js"></script>

    <script type="text/javascript" src="jslibs/frontend_support.js"></script>
  <head>
    <title>RRD matrix by frontend groups</title>
  </head>

  <body>
    <table width="100%">
    <tr>
     <td><h1 id="title">RRD matrix by frontend groups</h1>
     <td align="right">[ 
	    <a href="frontendStatus.html">Status</a> |
	    <a href="frontendRRDBrowse.html">Browse</a> |
        <a href="frontendGroupGraphStatusNow.html">Group Graphs</a>
	    ]
    </tr>
    </table>

    <table border=0>
     <tr>
       <th>Groups</th>
       <td><form id="groups">
       </form></td>
     </tr>
     <tr>
       <th>RRD</th>
       <td><form id="rrds">
	<input type="radio" name="rrd" value="Status_Attributes" checked>Status_Attributes
       </form></td>
     </tr>
     <tr>
      <td colspan=2><button onclick="fname_update()">Update</button></td>
     </tr>
    </table>

    <hr>

    <table id="infotable" border=1>
        <tr><td colspan="21"><b>Javascript needed for this page to work</b></td></tr>
	<tr><td><b>RRD file</b></td><td id="fname" colspan="5">None</td></tr>
    </table>

    <div id="mygraph"></div>

   <hr>
    <p>Powered by
        <a href="http://oss.oetiker.ch/rrdtool/" target="_blank">RRDTool</a>,
        <a href="https://sourceforge.net/projects/javascriptrrd/" target="_blank">JavascriptRRD</a> and                                                                 <a href="http://code.google.com/p/flot/" target="_blank">Flot</a>.
 
    <script type="text/javascript">

      // Remove the Javascript warning
      document.getElementById("infotable").deleteRow(0);

      // Load the status of the frontend
      var frontendStats=loadFrontendStats();
      var groups=getFrontendGroups(frontendStats);
      for (var group in groups) {
	var cb_el = document.createElement("input");
	cb_el.type = "checkbox";
	cb_el.name = "group";
	cb_el.value = groups[group];
	cb_el.checked = cb_el.defaultChecked = true;

        var html_el=document.getElementById("groups");
	html_el.appendChild(cb_el);
        html_el.appendChild(document.createTextNode(groups[group]));
      }

     // fname and rrd_data are the global variable used by all the functions below
      rrd_name="";
      group_names=[];
      fnames=[];
      rrd_data=[];

      // This function updates the Web Page with the data from the RRD archive header
      // when a new file is selected
      function update_fname() {
        // Finally, update the file name and enable the update button
        document.getElementById("fname").firstChild.data=rrd_name;

	var rrd_files=[];
	for (var i in rrd_data) {
	   rrd_files.push([group_names[i],rrd_data[i]]);
	} 

        // the rrdFlot object creates and handles the graph
        var f=new rrdFlotMatrix("mygraph",rrd_files);
      }

      // This is the callback function that,
      // given a binary file object and an index,
      // verifies that it is a valid RRD archive
      // checks if all have been updated
      // and performs the update of the Web page
      function update_fname_handler(bf, idx) {
          document.getElementById("fname").firstChild.data=document.getElementById("fname").firstChild.data+".";

          var i_rrd_data=undefined;
          try {
            var i_rrd_data=new RRDFile(bf);            
          } catch(err) {
            alert("File "+fnames[idx]+" is not a valid RRD archive!");
          }
          if (i_rrd_data!=undefined) {
            rrd_data[idx]=i_rrd_data;
          }
	  var all_defined=true;
          for (var i in rrd_data) {
            if (rrd_data[idx]==null) {
	       all_defined=false;
	    }
	  } 

           if (all_defined) {
            update_fname()
          }
      }

      // this function is invoked when the RRD file name changes
      function fname_update() {
	fnames=[];
	rrd_data=[];

	group_names=[];
        rrd_name="";

        var groups_obj=document.getElementById("groups")
	if (groups_obj.group.length>0) {
          for (var i in groups_obj.group) {
           var group=groups_obj.group[i];
           if (group.checked==true) {
  	     group_names.push(group.value);
           } 
          }
        } else {
	  group_names.push(groups_obj.group.value);
        }

        var rrds_obj=document.getElementById("rrds")
	if (rrds_obj.rrd.length>0) {
          for (var i in rrds_obj.rrd) {
           var rrd=rrds_obj.rrd[i];
           if (rrd.checked==true) {
  	     rrd_name=rrd.value;
           }
          }
        } else { // single element is not an array
          rrd_name=rrds_obj.rrd.value;
        }

        for (var i in group_names) {
          fnames.push("group_"+group_names[i]+"/total/"+rrd_name+".rrd");
          rrd_data.push(null);
        }

	document.getElementById("fname").firstChild.data="Loading "+rrd_name;
        for (var i in group_names) {
          try {
            FetchBinaryURLAsync(fnames[i],update_fname_handler,i);
          } catch (err) {
             alert("Failed loading "+fnames[i]+"\n"+err);
          }
	}
      }
    </script>
  </body>
</html>
