<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<!--
Project:
  glideinWMS

File Version: 
  $Id: factoryRRDBrowse.html,v 1.13.8.7 2011/06/26 23:12:16 sfiligoi Exp $

Description:
  Browse the glideinWMS RRDs

  Based on
  javascriptrrd/src/lib/rrdJFlot.html 
   Original repository: http://javascriptrrd.sourceforge.net/
-->

<html>
  
    <script type="text/javascript" src="jslibs/binaryXHR.js"></script>
    <script type="text/javascript" src="jslibs/rrdFile.js"></script>
    <script type="text/javascript" src="jslibs/rrdMultiFile.js"></script>
    <script type="text/javascript" src="jslibs/rrdFilter.js"></script>
    <script type="text/javascript" src="jslibs/rrdFlot.js"></script>

    <!-- rrdFlot class needs the following four include files !-->
    <script type="text/javascript" src="jslibs/rrdFlotSupport.js"></script>
    <script type="text/javascript" src="jslibs/rrdFlot.js"></script>
    <script type="text/javascript" src="jslibs/jquery.js"></script>
    <script type="text/javascript" src="jslibs/jquery.flot.js"></script>
    <script type="text/javascript" src="jslibs/jquery.flot.selection.js"></script>

    <script type="text/javascript" src="jslibs/factory_support.js"></script>
  <head>
    <title>Browse gfactory RRDs</title>
  </head>

  <body>
    <table width="100%">
    <tr>
     <td><h1 id="title">Browse gfactory RRDs</h1>
     <td align="right">
     <SELECT id="destination" style="float:right" onChange="goToDestination(this)" >
<OPTION VALUE="" >Choose a Glidein destination...</OPTION>
<OPTION VALUE="factoryEntryStatusNow.html"> Glidein entry. </OPTION>
<OPTION VALUE="factoryStatusNow.html"> Glidein factory status now. </OPTION>
<OPTION VALUE="factoryStatus.html"> Glidein factory status. </OPTION>
<OPTION VALUE="factoryLogStatus.html"> Glidein factory log status. </OPTION>
<OPTION VALUE="factoryCompletedStats.html"> Glidein factory completed stats. </OPTION>
<OPTION VALUE="factoryRRDEntryMatrix.html"> Glidein factory entry matrix. </OPTION>
</SELECT>
    </tr>
    </table>

    <table border=0>
     <tr>
       <th>Entry</th>
       <td valing="middle">
         <select id="entries" onchange="setFrontendMenu(document.getElementById('entries').options[document.getElementById('entries').selectedIndex].value);">
	  <option value="total">total</option>
	 </select>
       </td>
     </tr>
     <tr>
       <th>Frontend</th>
       <td valing="middle">
         <select id="frontends">
          <option value="total">total</option>
         </select>
       </td>
     </tr>
     <tr>
       <th>RRD</th>
       <td valign="middle"><form id="rrds">
	<input type="radio" name="rrd" value="Status_Attributes" checked>Status_Attributes
	<input type="radio" name="rrd" value="Log_Counts">Log_Counts
	<input type="radio" name="rrd" value="Log_Completed">Log_Completed
	<input type="radio" name="rrd" value="Log_Completed_Stats">Log_Completed_Stats
	<input type="radio" name="rrd" value="Log_Completed_WasteTime">Log_Completed_WasteTime
       </form></td>
     </tr>
     <tr>
       <td colspan=2>
         <button onClick="nonlink_update()">Update</button>
         <button onClick="defaults()" style="float:right">Defaults</button>
         <button onClick="unlink()" style="float:right">Unlink</button>
         <button onClick="showLink()" style="float:right">Link</button>
       </td>
     </tr>
    </table>

    <hr>

    <table id="infotable" border=1>
        <tr><td colspan="21"><b>Javascript needed for this page to work</b></td></tr>
	<tr><td><b>RRD file</b></td><td id="fname" colspan="5">None</td></tr>
    </table>

    <div id="mygraph"></div>

   <hr>
    <p>Powered by
        <a href="http://oss.oetiker.ch/rrdtool/" target="_blank">RRDTool</a>,
        <a href="https://sourceforge.net/projects/javascriptrrd/" target="_blank">JavascriptRRD</a> and                                                                 <a href="http://code.google.com/p/flot/" target="_blank">Flot</a>.
 
    <script type="text/javascript">

      var rrdOptions = new Array("Status_Attributes", "Log_Counts", "Log_Completed", "Log_Completed_Stats", "Log_Completed_WasteTime");
      var ENTRY; 
      var graph_info;
      var specified_rra = 0;
      var windows = true;
      var link_checked_DSs = [];
      var local_window_min=0;
      var local_window_max=0;
      var coming_from_defaults = false;
      var coming_from_link = true;
      var timezone_num=0;

      // Remove the Javascript warning
      document.getElementById("infotable").deleteRow(0);

      // Load the status of the factory
      var factoryQStats=loadFactoryQStats();
      //var entries=getFactoryEntries(factoryQStats);

      var entries=getFactoryEntryGroups(factoryQStats);
      var frontend_list=getFactoryFrontends(factoryQStats);
      group_map = entries;
      char_count=0;
      groups_starting_idx = 0;
      var entries_processed = 0;

      var ordered_entries_groups = [];
      for(entry in entries) {
          var e = (entries[entry]).toString();
          if (((e.split(",")).length == 1) && (e == entry.toString())){
              ordered_entries_groups[entry] = entries[entry];
              groups_starting_idx++;
          }
      }
      for(entry in entries) {
          var e = (entries[entry]).toString();
          if (((e.split(",")).length > 1) || (e != entry.toString())){
              ordered_entries_groups[entry] = entries[entry];
          }
      }
      entries = ordered_entries_groups;

      var entries_select=document.getElementById("entries");
      var frontends_select=document.getElementById("frontends");
      var sep1 = new Option("--------------------","-");
      var sep2 = new Option("--------------------","-");
      sep1.disabled = true;
      sep2.disabled = true;
      entries_select.appendChild(sep1);
      var ec_added = 0;
      for (var entry in entries) {
          if (ec_added < groups_starting_idx) {
              entries_select.appendChild(new Option(entries[entry],entries[entry]));
              ec_added++;
          } else {
              if ((ec_added == groups_starting_idx) && (ec_added != 0)){ 
                  entries_select.appendChild(sep2);
              }
              entries_select.appendChild(new Option(entry,entries[entry]));
              ec_added++;
          } 
      }

     // fname and rrd_data are the global variable used by all the functions below
      rrd_data=undefined;
      gtype_id=undefined;
      rrd_group_data=[];
      files_loaded = 0;
	  checkUrl(); 

      function setFrontendMenu(entry) {
        var fes = document.getElementById("frontends");
        //Remove frontends from previous entry choices, add back 'total'
        // and this entry's frontends. 
        while(fes.childNodes.length>0) {fes.removeChild(fes.firstChild);}
        fes.appendChild(new Option('total','total'));
        for(var frontend in frontend_list[entry]) {
           frontends_select.appendChild(new Option(frontend_list[entry][frontend]));
        }
      }

      function entrylist2groupname(elist) {
          var gname = elist;
          for(var g in group_map) {
              if ((group_map[g] == elist) && (g.toString() != elist)){
                  gname = g;
                  break;
              }
          }
          return gname;
      }

      //RRA Filter - leaves it alone.
      function RRADoNothing(rra_idx) {
         this.getIdx = function() {return rra_idx;}
         this.getStep = function() {return null;}
      }
      
      /* RRA Filter - Creates a new RRA with a different step size (in seconds) 
      / based on another RRA, whose data the new RRA averages. 
      / rra_idx should be index of RRA with largest step size that doesn't exceed new step size.
      */
      function RRA_Avg(rra_idx,new_step_in_seconds) {
         this.getIdx = function() {return rra_idx;}
         this.getStep = function() {return new_step_in_seconds;}
      }

//---------------------------------------------------------------------------------------

      // This function updates the Web Page with the data from the RRD archive header
      // when a new file is selected
      function update_fname() {

      /////////////////////////////////////////////////////////////////
      //check previously defined checked DSs, if any match this new gtype, then preserve them
      //also preserve rra and window selection across info group updates
      graph_info = getGraphInfo();

      //preserve window selection
      if(!coming_from_link) { //get from graph
         windows = true;
         local_window_max = graph_info['window_max'];
         local_window_min = graph_info['window_min'];
      } //if coming from link, use link params (which are already set)

      if(coming_from_defaults) {
         windows=false;
      }

      //preserve rra
      if(specified_rra==null || coming_from_defaults) {specified_rra=0;}
      else if (!coming_from_link) {specified_rra = graph_info["rra"];}
        
      //if coming from link, used DS elements provided in link
      //else, use preserved elements across link
      var use_checked_DSs_local = true;
      if(!coming_from_link) {
         use_checked_DSs_local = false;
      }   

      if (local_window_max==0 && local_window_min==0) {windows=false;} 

       ///////////////////////////////////////////////////////////

      //Add RRA filters for longer averaged-out RRAs
      var rra_op_list = [];
      for(var i=0; i<rrd_data.getNrRRAs();i++) {
         if(i==2) {rra_op_list.push(new RRA_Avg(1,14400));} //4 hours, based on rra at idx 1 (added here for ordering)
         rra_op_list.push(new RRADoNothing(i));
      }
      rra_op_list.push(new RRA_Avg(2,86400)); //24 hours - base off rra at index 2
      rra_op_list.push(new RRA_Avg(2,604800)); //1 week

      if(rrd_group_data.length!=0) {rrd_data = new RRDFileSum(rrd_group_data,false);}

      rrd_data = new RRDRRAFilterAvg(rrd_data,rra_op_list); //Adds 2 extra RRAs (averaged)

      // the rrdFlot object creates and handles the graph
      var f=new rrdFlot("mygraph",rrd_data,null,null,{timezone: timezone_num, use_checked_DSs: use_checked_DSs_local, checked_DSs: link_checked_DSs,use_rra:true,rra:specified_rra, use_windows: windows, window_min:local_window_min, window_max: local_window_max, use_element_buttons:false});

        // Finally, update the files loaded so far
        files_loaded = files_loaded + 1;
        var total_file_to_load = fname.split(",").length
        if (files_loaded < total_file_to_load) {
            document.getElementById("fname").firstChild.data="Loaded files " + files_loaded + "/" + total_file_to_load;
        }
        else {
            document.getElementById("fname").firstChild.data="Loaded files " + files_loaded + "/" + total_file_to_load + ": " + fname;
        }
      }

      // This is the callback function that,
      // given a binary file object,
      // verifies that it is a valid RRD archive
      // and performs the update of the Web page
      function update_fname_handler(bf) {
          var i_rrd_data=undefined;
          try {
            var i_rrd_data=new RRDFile(bf);            
          } catch(err) {
            alert("File "+fname+" is not a valid RRD archive!");
          }
          if (i_rrd_data!=undefined) {
            rrd_data=i_rrd_data;
            update_fname()
          }
      }


      function update_grouped_fname_handler(bf) {
          var i_rrd_data=undefined;
          var idx = 0;
          if (rrd_group_data != undefined) {
            idx = rrd_group_data.length;
          } else {
            rrd_group_data = [];
          }

          try {
            var i_rrd_data=new RRDFile(bf);            
          } catch(err) {
            alert("File "+fname+" is not a valid RRD archive!");
          }
          if (i_rrd_data!=undefined) {
            rrd_group_data[idx] = new Array(); 
            rrd_group_data[idx] = i_rrd_data;
            update_fname()
          }
      }

      function nonlink_update() {
         coming_from_link = false;
         fname_update();
      }

      // this function is invoked when the RRD file name changes
      function fname_update() {
        rrd_group_data=[];
        rrd_data=undefined;
        files_loaded=0;

        var entry_name="";
        var rrd_name="";

        var entries_obj=document.getElementById("entries")
        entry_name=entries_obj.options[entries_obj.selectedIndex].value;
        var frontend_obj=document.getElementById("frontends")
        frontend_name=frontend_obj.options[frontend_obj.selectedIndex].value;

        var rrds_obj=document.getElementById("rrds")
        for (var i in rrds_obj.rrd) {
         var rrd=rrds_obj.rrd[i];
         if (rrd.checked==true) {
  	   rrd_name=rrd.value;
         }
        }

        if (entry_name=="total") {
          fname="total/"+rrd_name+".rrd";
        } else if (frontend_name!="total"){
          fname="entry_"+entry_name+"/frontend_"+frontend_name+"/"+rrd_name+".rrd";
        } else {
          fname="entry_"+entry_name+"/total/"+rrd_name+".rrd";
        }

        if ( (entry_name == "total") || (((entry_name.split(",")).length == 1) && (entry_name == entrylist2groupname(entry_name.split(",")))) ){
          //document.getElementById("fname").firstChild.data="Loading "+fname;
          document.getElementById("fname").firstChild.data="Loaded files " + files_loaded + "/" + fname.split(",").length;
          try {
            FetchBinaryURLAsync(fname,update_fname_handler);
          } catch (err) {
             alert("Failed loading "+fname+"\n"+err);
          }
        } else {
          var en_array = entry_name.split(",");
          fname = "";
          for (var i=0; i<en_array.length; i++) {
              if (i == 0) {
                  fname="entry_"+en_array[i]+"/total/"+rrd_name+".rrd";
              } else {
                  fname=fname+",entry_"+en_array[i]+"/total/"+rrd_name+".rrd";
              }
          }
          //document.getElementById("fname").firstChild.data="Loading " + fname;
          document.getElementById("fname").firstChild.data="Loaded files " + files_loaded + "/" + fname.split(",").length;

          for (var i=0; i<en_array.length; i++) {
            //alert("GROUP SELECTED with entry: " + en_array[i]);
            var fn = "entry_"+en_array[i]+"/total/"+rrd_name+".rrd"; 
            try {
              FetchBinaryURLAsync(fn,update_grouped_fname_handler);
            } catch (err) {
               alert("Failed loading "+fn+"\n"+err);
            }
          }
        }
      }
	  /* Function to read from the url any parameters the user has specified. */
	function checkUrl()
	{
		var url = window.location.search;
                parameterArry = new Array("entry", "frontend", "infoGroup","elements","rra","window_min","window_max","timezone"); 
		groups = new Array("CMST1", "CMS", "CMST2", "US", "CMST3", "HCC");
		group = 0;  
		var entrySpec; 
		var infoGroupSpec;
                link_checked_DSs=[];
                specified_rra = 0;
		urlValid = 0; 
		paramSpecArry = new Array(); 
		if(url)
		{
			url = url.substring(1);
			urlSplit = url.split('&'); 
			i = 0; 
			while(i < urlSplit.length)
			{ 
				equalSplit = urlSplit[i].split('='); 
				if(equalSplit[0] == parameterArry[i])
				{
					paramSpecArry[i] = equalSplit[1];
				}
				i++; 
			}
		}
		for(i = 0; i< paramSpecArry.length; i++)
		{
			counter = 2; 
			if(i == 0)
			{
				for(entry in entries)
				{
					if(entry == paramSpecArry[0])
					{
						ENTRY = paramSpecArry[0]; 
						urlValid = 1; 
						for(j = 0; j< groups.length; j++)
						{
							if(entry == groups[j])
							{
								document.getElementById("entries").selectedIndex = counter + 1; 
                                                                setFrontendMenu(entry);
								group = 1;
								break;  
							}	
						}
						if(!group)
						{
							document.getElementById("entries").selectedIndex = counter; 
                                                        setFrontendMenu(entry);
                                                        var frontend = paramSpecArry[1];
                                                        var fe_list = document.getElementById("frontends").childNodes; 
                                                        var fe_idx=0;
                                                        for(var k=0;k<fe_list.length;k++) {
                                                           document.write(fe_list[k].innerHTML);
                                                           if(frontend==fe_list[k].innerHTML) {fe_idx=k;}
                                                        }
                                                        document.getElementById("frontends").selectedIndex = fe_idx; 
						}
						break;
					} 
					else if("total" == 	paramSpecArry[0])
					{
						urlValid = 1; 
						document.getElementById("entries").selectedIndex = 0; 
                                                setFrontendMenu(entry);
						break;  	
					}
					counter++; 
				}
			}
			else if(i == 2)
			{
				child = 1; 
				for(var k = 0; k< rrdOptions.length; k++)
				{
					if(rrdOptions[k] == paramSpecArry[2])
					{
						document.getElementById("rrds").elements[k].checked = true;
						urlValid = 1; 
					}
					child+=2;	
				}
			}
                        else if(i==3) {
                           var elems = paramSpecArry[i].split(",");
                           for(var j=0;j<elems.length;j++){
                              link_checked_DSs.push(elems[j]);
                           } 
                        }
                        else if(i==4) {specified_rra = paramSpecArry[i];}
                        else if(i==5) {local_window_min = paramSpecArry[i];}
                        else if(i==6) {local_window_max = paramSpecArry[i];}
                        else if(i==7) {timezone_num = paramSpecArry[i];}
		}
		if(urlValid)
		{
			fname_update();
		}
	}
	/* Function to show link for current options. */
	function showLink()
	{
		constructed = document.URL.split('?');
		entriesTable = document.getElementById("entries"); 
                frontendsTable = document.getElementById("frontends"); 
                var specifiedEntry;
                var specifiedFrontend;
		var specifiedGOption; 
                var specified_win_max; 
                var specified_win_min; 

                //Graph data from rrdFlot.js
                graph_info = getGraphInfo();
                var local_checked_DSs_input= graph_info["dss"];
                specified_rra = graph_info["rra"];
                specified_timezone = graph_info["timezone"];
                specified_win_min = graph_info["window_min"];
                specified_win_max = graph_info["window_max"];

		/* Find the current entry specified. */
		for(i = 0; i < entriesTable.options.length; i++)
		{
			if(entriesTable.options[i].selected == true)
			{
				specifiedEntry = entriesTable.options[i].text; 	
			}
		}
                /* Find the current frontend specified. */
                for(i = 0; i < frontendsTable.options.length; i++)
                {
                        if(frontendsTable.options[i].selected == true)
                        {
                                specifiedFrontend = frontendsTable.options[i].text;     
                        }
                }
		rrdTable = document.getElementById("rrds");
		j = 0;  
		/* Find the current group option specified. */
		for(i = 1; i< rrdTable.childNodes.length; i+=2)
		{
			if(rrdTable.childNodes[i].checked == true)
			{
				specifiedGOption = rrdOptions[j];
			}
			if(rrdTable.childNodes[i].value)
			{
				j++;
			}
		}
                var elem_string = "";
                for(var i=0;i<local_checked_DSs_input.length;i++) {
                   elem_string += local_checked_DSs_input[i]+",";
                }

                constructed = constructed[0]+"?entry="+specifiedEntry+"&frontend="+specifiedFrontend+"&infoGroup="+specifiedGOption+"&elements="+elem_string+"&rra="+specified_rra+"&window_min="+specified_win_min+"&window_max="+specified_win_max+"&timezone="+specified_timezone; 
		document.location.href = constructed; 
	}  

        function unlink() {
           document.location.href= document.URL.split('?')[0];
        }
        function defaults() {
           local_checked_DSs = [];
           link_checked_DSs = [];
           specified_rra = null;
           coming_from_defaults = true;
           resetWindow();
           update_fname();
        }

	/* Function to navigate to other glidein tools. */
	function goToDestination(option)
	{
		if(option.value != "factoryStatusNow.html" && option.value != "factoryRRDEntryMatrix.html" && ENTRY)
		{
			document.location.href = option.value + "?entry=" + ENTRY; 
		}
		else
		{
			document.location.href = option.value; 
		}
		document.getElementById("destination").selectedIndex = 0; 
	}
    </script>
  </body>
</html>
