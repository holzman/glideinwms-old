#!/usr/bin/env python

import os, sys, getopt, re 
import datetime
import urllib
STARTUP_DIR=sys.path[0]
sys.path.append(os.path.join(STARTUP_DIR,"../../lib"))

import xmlParse

def main():

    usage="""
USAGE: 
    -x [#] : intverval to do verbose stats (default 24)
    --source [ABSPATH or http addr] : factory base (default current directory)
    -w : sort by wasted time
    -f [frontend] : filter by a single frontend
         (can omit "frontend_" before name)
    -h : this usage message
"""
    x = 24
    dir = os.getcwd()
    sort_waste = 0
    filter_frontend = 0
 
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'x:hwf:', ['source='])
    except getopt.GetoptError:
        print("\n Option not recognized or missing parameters.")
        print(" Use -h for usage.\n")
        sys.exit(0)
    for o, a in opts:
        if o == "-x":
            x = a
        elif o == "--source":
            dir = a
        elif o in ("-h", "-help"):
            print usage
            return
        elif o == "-w":
            sort_waste = 1
        elif o == "-f":
            filter_frontend = a
            if 'frontend_' not in filter_frontend:
                filter_frontend = 'frontend_' + filter_frontend


    data = {}
    rrd_list = {"completed_data": "rrd_Log_Completed.xml", 
                "job_dur_data": "rrd_Log_Completed_Stats.xml", 
                "wastemill_data": "rrd_Log_Completed_WasteTime.xml"}

    for name, xml in rrd_list.iteritems():

        if "http" in dir:
            file_dir = os.path.join(dir, xml)
        else: 
            file_dir = os.path.join(dir, "monitor", xml)
    
        try:  
            u = urllib.urlopen(file_dir)        
            data[name] = xmlParse.xmlfile2dict(u)
        except:
            print "\nCannot open", file_dir,"\n\tor",xml,"was not found there.\n"
            raise
        u.close()


    c_data = data["completed_data"]
    j_data = data["job_dur_data"]
    w_data = data["wastemill_data"]


###############################################################################
#   Rearranges rrd_data into data = [periods][frontends][entries][elements]
#      (periods are integers and in seconds)
###############################################################################

    data = {}
    frontend_list = []

    for entry in c_data['entries']:
        for frontend in c_data['entries'][entry]['frontends']:
            if frontend not in frontend_list:
                frontend_list.append(frontend)

    if filter_frontend != 0:
        if filter_frontend not in frontend_list:
            print "\nFrontend", filter_frontend, "not found at source.\n"
            print "Choices are:\n "
            for frontend in frontend_list:
                print frontend
            print
            sys.exit(1)
      
    for entry in c_data['entries']:

        for frontend in c_data['entries'][entry]['frontends']:

            if filter_frontend != 0:
                if frontend != filter_frontend:
                    continue
            
            for period in c_data['entries'][entry]['frontends'][frontend]['periods']:

                if int(period) not in data:
                    data[int(period)] = {}
                if frontend not in data[int(period)]:
                    data[int(period)][frontend] = {}
                if entry not in data[int(period)][frontend]:
                    data[int(period)][frontend][entry] = {}

                for x_data in [c_data, j_data, w_data]:
                    for a, b in x_data['entries'][entry]['frontends'][frontend]['periods'][period].iteritems():
                        data[int(period)][frontend][entry][a] = int(float(b)*int(period))   

    

######################################################################
# Organize totals/stats for each period, frontend, and entry independantly
######################################################################


    if filter_frontend == 0:
        print("""
Glidein log analysis for All Entries - %s
""" % datetime.datetime.now().strftime("%d-%m-%Y_%H:%M:%S"))
    else: print("""
Glidein log analysis for frontend %s - %s
""" % (filter_frontend, datetime.datetime.now().strftime("%d-%m-%Y_%H:%M:%S")))
          

    period_data = {}
    frontend_data = {}
    entry_data = {}
    entry_data_all_frontends = {}
    
    for period, frontends in data.iteritems():
        glideins, jobs, used, waste, validation, idle, badput = 0,0,0,0,0,0,0

        period = int(period)
        period_data[period] = {}
        period_data[period]['total_time'] = 0
        frontend_data[period] = {}
        entry_data[period] = {}
        entry_data_all_frontends[period] = {}

        for frontend, entries in frontends.iteritems(): 

            fglideins, fjobs, fused, fwaste, fvalidation, fidle, fbadput = 0,0,0,0,0,0,0
            frontend_data[period][frontend] = {}
            frontend_data[period][frontend]['total_time'] = 0
            entry_data[period][frontend] = {}

            for entry, elements in entries.iteritems():
                eglideins, ejobs, eused, ewaste, evalidation, eidle, ebadput = 0,0,0,0,0,0,0
                entry_data[period][frontend][entry] = {}  

                eglideins = elements["Glideins"]
                ejobs = elements["JobsNr"]
                eused = elements["JobsGoodput"]

                for name, value in elements.iteritems():
                    if 'badput' in name:
                        multiplier = re.findall('badput_(.*)', name)[0].rstrip('m')
                        if multiplier == "All": multiplier = 1000
                        if multiplier == "Most": multiplier = 750 # approximation
                        if multiplier == "None": multiplier = 0
                        ewaste += value*(int(multiplier)*1.0e-3)
                    if 'validation' in name:
                        multiplier = re.findall('validation_(.*)', name)[0].rstrip('m')
                        if multiplier == "All": multiplier = 1000
                        if multiplier == "Most": multiplier = 750 # approximation
                        if multiplier == "None": multiplier = 0
                        evalidation += value*(int(multiplier)*1.0e-3)
                    if 'idle' in name:
                        multiplier = re.findall('idle_(.*)', name)[0].rstrip('m')
                        if multiplier == "All": multiplier = 1000
                        if multiplier == "Most": multiplier = 750 # approximation
                        if multiplier == "None": multiplier = 0
                        eidle += value*(int(multiplier)*1.0e-3)
                
                if entry not in entry_data_all_frontends[period]:
                    entry_data_all_frontends[period][entry] = {} 

                for a in ['FailedNr','validation_All','JobsNr_None','badput_All','Lasted']:
                    if a not in entry_data_all_frontends[period][entry]:
                        entry_data_all_frontends[period][entry][a] = data[period][frontend][entry][a]
                    else: entry_data_all_frontends[period][entry][a] += data[period][frontend][entry][a]

                ewaste = data[period][frontend][entry]["Lasted"] - data[period][frontend][entry]["JobsLasted"]
                ebadput = data[period][frontend][entry]["Lasted"] - data[period][frontend][entry]["JobsGoodput"]

                period_data[period]['total_time'] += data[period][frontend][entry]["Lasted"]
                frontend_data[period][frontend]['total_time'] += data[period][frontend][entry]["Lasted"]

                for name, value in {'glideins': eglideins, 
                         'jobs': ejobs,
                         'used': eused,
                         'waste': ewaste,
                         'validation': evalidation,
                         'badput': ebadput,
                         'idle': eidle}.iteritems():

                    entry_data[period][frontend][entry][name] = value

                    if name not in entry_data_all_frontends[period][entry]:
                        entry_data_all_frontends[period][entry][name] = value
                    else: entry_data_all_frontends[period][entry][name] += value

                fglideins += eglideins
                fjobs += ejobs
                fused += eused
                fwaste += ewaste
                fvalidation += evalidation
                fidle += eidle
                fbadput += ebadput

            for name, value in {'glideins': fglideins, 
                     'jobs': fjobs,
                     'used': fused,
                     'waste': fwaste,
                     'validation': fvalidation,
                     'badput': fbadput,
                     'idle': fidle}.iteritems():
                frontend_data[period][frontend][name] = value

            glideins += fglideins
            jobs += fjobs
            used += fused
            waste += fwaste
            validation += fvalidation
            idle += fidle
            badput += fbadput

        for name, value in {'glideins': glideins, 
                     'jobs': jobs,
                     'used': used,
                     'waste': waste,
                     'validation': validation,
                     'badput': badput,
                     'idle': idle}.iteritems():
            period_data[period][name] = value


######################################################################
#   Print
######################################################################

    period_list = period_data.keys()
    period_list.sort() 

    for period in period_list:
        
        title = ("Past %.1f hours" % (float(period)/3600))

        if period_data[period]['glideins'] == 0:
            continue        
        if period_data[period]['waste'] == 0:
            period_data[period]['waste'] = 1

        print(
"""----------------------------------------
%s:

Total Glideins: %s
Total Jobs: %d (Average jobs/glidein: %.2f) 

Total time: %d s (%d hours - %.1f slots)
Total time used: %d s (%d hours - %.1f slots)
Total time in validation: %d s (%d hours - %.1f slots)
Total time idle: %d s (%d hours- %.1f slots)
Total time wasted: %d s (%d hours - %.1f slots)
Time used/time wasted: %.1f
Time efficiency: %.2f
"""
     % (title, 
       period_data[period]['glideins'], 
       period_data[period]['jobs'], 
       float(period_data[period]['jobs'])/float(period_data[period]['glideins']),
       period_data[period]['total_time'],
       period_data[period]['total_time']/3600,
       float(period_data[period]['total_time'])/float(period),
       period_data[period]['used'],
       period_data[period]['used']/3600, 
       float(period_data[period]['used'])/float(period),
       period_data[period]['validation'],
       period_data[period]['validation']/3600, 
       float(period_data[period]['validation'])/float(period),
       period_data[period]['idle'],
       period_data[period]['idle']/3600, 
       float(period_data[period]['idle'])/float(period),
       period_data[period]['waste'],
       period_data[period]['waste']/3600, 
       float(period_data[period]['waste'])/float(period),
       float(period_data[period]['used'])/float(period_data[period]['waste']),
       float(period_data[period]['used'])/float(period_data[period]['waste']+period_data[period]['used'])))


    if period not in data:
        print "Interval",x,"does not exist in data.\n"# Choices are:",c_data['total']['period'].keys(),"\n"
        return

################################################################################
#    Print per entry stats (all frontends)
################################################################################

    period = int(x)*3600

    if filter_frontend == 0:

        print """
---------------------------------------
---------------------------------------
Per Entry (all frontends) stats for the past %s hours.\n""" % x


        print("%-40s%5s %3s %4s | %4s %4s %4s %4s | %6s %7s %7s" % ( 
                  "", "strt","fval","0job","val","idle","wst","badp","waste","time","total"))

        to_be_printed = {}  # dict of paired entry data with wastetime for sorting

        for entry_name, entry in entry_data_all_frontends[period].iteritems():
 
            if entry['glideins'] == 0 or entry['Lasted'] == 0:
                continue

            if entry['validation'] == 0:
                entry['validation'] = 1
            
                           
            to_be_printed[int(entry['waste'])] = ("%-40s %3d%% %3d%% %3d%% | %3d%% %3d%% %3d%% %3d%% | %6d  %6d  %1s %4d" 
                 % (entry_name.lstrip("entry_"),
                    (float(entry['FailedNr'])/float(entry['glideins']))*100,
                    (float(entry['validation_All'])/float(entry['Lasted']))*100,
                    (float(entry['JobsNr_None'])/float(entry['glideins']))*100,
                    #(float(entry['badput_All'])/float(entry['Lasted']))*100,
                    (float(entry['validation'])/float(entry['Lasted']))*100,
                    (float(entry['idle'])/float(entry['Lasted']))*100,
                    (float(entry['waste'])/float(entry['Lasted']))*100,
                    (float(entry['badput'])/float(entry['Lasted']))*100,
                    entry['waste']/3600.0,
                    #(entry_data[period][frontend][entry]['used']+entry_data[period][frontend][entry]['waste'])/3600.0,
                    entry['Lasted']/3600.0,
                    "|",
                    entry['glideins']))

        if sort_waste == 1:
            wastetimes = to_be_printed.keys()
            wastetimes.sort()
            wastetimes.reverse()
            for a in wastetimes:
                print to_be_printed[a]
            print("----------------------------------")
        else: 
            for a in to_be_printed:
                print to_be_printed[a]


################################################################################
#    Print per frontend per entry stats
################################################################################


    print """
---------------------------------------
---------------------------------------
Per Entry (per frontend) stats for the past %s hours.\n""" % (x)

    for frontend, entries in data[period].iteritems():

        if period_data[period]['glideins'] == 0 or frontend_data[period][frontend]['glideins'] == 0:
            continue

        # to avoid divisions by zero
        if frontend_data[period][frontend]['waste'] == 0:
            frontend_data[period][frontend]['waste'] = 1

        if filter_frontend == 0:
            print ("""
\n%s

Glideins: %s - %.1f%% of total
Jobs: %s (Average jobs/glidein: %.2f)

Total time: %s s (%d hours - %.1f slots)
Total time used: %s s (%d hours - %.1f slots)
Total time in validation: %s s (%d hours - %.1f slots)
Total time idle: %s s (%d hours - %.1f slots)
Total time wasted: %s s (%d hours - %.1f slots)
Time used/time wasted: %.2f
Time efficiency: %.2f
""" % ( "Frontend: "+frontend, 
        frontend_data[period][frontend]['glideins'], 
        float(frontend_data[period][frontend]['glideins'])/float(period_data[period]['glideins'])*100, 
        frontend_data[period][frontend]['jobs'], 
        float(frontend_data[period][frontend]['jobs'])/float(frontend_data[period][frontend]['glideins']), 

        frontend_data[period][frontend]['total_time'],
        frontend_data[period][frontend]['total_time']/3600,
        float(frontend_data[period][frontend]['total_time'])/float(period), 

        frontend_data[period][frontend]['used'], 
        frontend_data[period][frontend]['used']/3600, 
        float(frontend_data[period][frontend]['used'])/float(period), 

        frontend_data[period][frontend]['validation'], 
        frontend_data[period][frontend]['validation']/3600, 
        float(frontend_data[period][frontend]['validation'])/float(period),

        frontend_data[period][frontend]['idle'], 
        frontend_data[period][frontend]['idle']/3600,
        float(frontend_data[period][frontend]['idle'])/float(period), 

        frontend_data[period][frontend]['waste'], 
        frontend_data[period][frontend]['waste']/3600,
        float(frontend_data[period][frontend]['waste'])/float(period), 

        float(frontend_data[period][frontend]['used'])/float(frontend_data[period][frontend]['waste']),
        float(frontend_data[period][frontend]['used'])/(float(frontend_data[period][frontend]['waste'])+float(frontend_data[period][frontend]['used'])))) 
            
        print("%-40s%5s %3s %4s | %4s %4s %4s %4s | %6s %7s %7s" % (
                  "", "strt","fval","0job","val","idle","wst","badp","waste","time","total"))

        to_be_printed = {}  # dict of paired entry data with wastetime for sorting

        for entry, e in entries.iteritems():

            # next 2 segments to avoid division by 0...find a better solution later

            if entry_data[period][frontend][entry]['glideins'] == 0 or e['Lasted'] == 0:
                continue

            if entry_data[period][frontend][entry]['validation'] == 0:
                entry_data[period][frontend][entry]['validation'] = 1
            
                           
            to_be_printed[int(entry_data[period][frontend][entry]['waste'])] = ("%-40s %3d%% %3d%% %3d%% | %3d%% %3d%% %3d%% %3d%% | %6d  %6d  %1s %4d" 
                     % (entry.lstrip("entry_"),
                        (float(e['FailedNr'])/float(entry_data[period][frontend][entry]['glideins']))*100,
                        (float(e['validation_All'])/float(e['Lasted']))*100,
                        (float(e['JobsNr_None'])/float(entry_data[period][frontend][entry]['glideins']))*100,
                        #(float(e['badput_All'])/float(e['Lasted']))*100,
                        (float(entry_data[period][frontend][entry]['validation'])/float(e['Lasted']))*100,
                        (float(entry_data[period][frontend][entry]['idle'])/float(e['Lasted']))*100,
                        (float(entry_data[period][frontend][entry]['waste'])/float(e['Lasted']))*100,
                        (float(entry_data[period][frontend][entry]['badput'])/float(e['Lasted']))*100,
                        entry_data[period][frontend][entry]['waste']/3600.0,
                        #(entry_data[period][frontend][entry]['used']+entry_data[period][frontend][entry]['waste'])/3600.0,
                        e['Lasted']/3600.0,
                        "|",
                        entry_data[period][frontend][entry]['glideins']))

        if sort_waste == 1:
            wastetimes = to_be_printed.keys()
            wastetimes.sort()
            wastetimes.reverse()
            for a in wastetimes:
                print to_be_printed[a]
            print("----------------------------------")
        else: 
            for a in to_be_printed:
                print to_be_printed[a]


################################################################################
#    Print Key
################################################################################


    print("""\n-----------------------------------
LEGEND:

strt - % of jobs where condor failed to start
fval - % of glideins that failed to validate (hit 1000s limit)
0job - %  0 jobs/glidein
----------
val - % of time used for validation
idle - % of time spend idle
wst - % of time wasted (Lasted - JobsLasted) 
badp - % of badput (Lasted - JobsGoodput)
----------
waste - wallclock time wasted (hours) (Lasted - JobsLasted)
time - total wallclock time (hours) (Lasted)
total - total number of glideins
-------------------------------------
        \n""")

if __name__ == "__main__":
    main()


