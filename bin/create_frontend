#!/usr/bin/env python

#
# Project:
#   glideinWMS
#
# File Version: 
#   $Id: create_frontend,v 1.3.6.3 2010/09/24 15:30:36 parag Exp $
#
# Description:
#  This program creates a frontend directory structure
#  based on a configuration file
#

import os
import sys
import traceback

import glideinwms_creation.cvWParams
import glideinwms_creation.cvWConsts
import glideinwms_creation.cWConsts
import glideinwms_creation.cvWCreate
import glideinwms_creation.cvWParamDict


################################################################################

def main(params, web_base):
    #print params.__dict__
    frontend_dicts_obj = glideinwms_creation.cvWParamDict.frontendDicts(params)
    frontend_dicts_obj.populate()

    frontend_dicts_obj.create_dirs()
    try:
        # save files in dictionaries
        frontend_dicts_obj.save()
        frontend_dicts_obj.set_readonly(True)

        # save config into file
        cfgfile = os.path.join(frontend_dicts_obj.main_dicts.work_dir, glideinwms_creation.cvWConsts.XML_CONFIG_FILE)
        params.save_into_file(cfgfile, set_ro=True)
        # make two copies, the second one should have a unique name, so it does not get overwritten on reconfig
        cfgfile = glideinwms_creation.cWConsts.insert_timestr(cfgfile)
        params.save_into_file(cfgfile, set_ro=True)

        # create the init.d starup file
        glideinwms_creation.cvWCreate.create_initd_startup(os.path.join(frontend_dicts_obj.main_dicts.work_dir, 
                                       glideinwms_creation.cvWConsts.INITD_STARTUP_FILE),
                                       frontend_dicts_obj.main_dicts.work_dir,
                                       os.path.realpath(os.path.join(web_base, '../..')))
    except:
        frontend_dicts_obj.delete_dirs()
        raise

    print "Created frontend '%s'" % params.frontend_name
    print "Active entries are:"
    for entry in frontend_dicts_obj.active_sub_list:
        print "  %s" % entry
    print "Work files can be found in %s" % frontend_dicts_obj.main_dicts.work_dir
    print "Log files can be found in %s" % frontend_dicts_obj.main_dicts.log_dir
    print "Support files are in %s" % frontend_dicts_obj.main_dicts.stage_dir
    print "Monitoring files are in %s" % frontend_dicts_obj.main_dicts.monitor_dir


############################################################
#
# S T A R T U P
# 
############################################################

if __name__ == '__main__':
    usage_prefix = "create_frontend [-writeback yes|no] [-debug] [-web_base path]"
    argv = sys.argv
    writeback = 'yes'
    debug = False
    web_base = sys.path[0]

    for i in range(len(argv)):
        if argv[i] == '-writeback':
            writeback = argv[i + 1]
        elif argv[i] == '-debug':
            debug = True
        if argv[i] == '-web_base':
            web_base = argv[i + 1]
        if argv[i] == '-help':
            print usage_prefix
            sys.exit(1)

    # AT - if this is packaged in FHS format, then we need to point to the proper location for web_base
    if web_base == "/usr/bin":
        web_base = "/usr/share/glideinwms"


    try:
        params = glideinwms_creation.cvWParams.VOFrontendParams(usage_prefix, web_base, argv)
    except RuntimeError, e:
        if debug:
            tb = traceback.format_exception(sys.exc_info()[0], sys.exc_info()[1], sys.exc_info()[2])
            print '\n'.join(tb)
        print e
        sys.exit(1)

    if not (writeback in ('yes', 'no')):
        print params.usage()
        print ""
        print "-writeback must be yes or no, found '%s'" % writeback
        sys.exit(1)

    try:
        main(params, web_base)
    except RuntimeError, e:
        if debug:
            tb = traceback.format_exception(sys.exc_info()[0], sys.exc_info()[1], sys.exc_info()[2])
            print '\n'.join(tb)
        print params.usage()
        print ""
        print e
        sys.exit(1)

    try:
        if writeback == 'yes':
            params.save_into_file_wbackup(params.cfg_name)
    except:
        if debug:
            tb = traceback.format_exception(sys.exc_info()[0], sys.exc_info()[1], sys.exc_info()[2])
            print '\n'.join(tb)
        print "Writing back config file failed"
        sys.exit(1)

